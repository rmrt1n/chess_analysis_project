---
title: "EDA"
output: html_notebook
---

### Load libraries
```{r}
library(readr)
library(dplyr)
library(magrittr)
library(ggplot2)
library(gridExtra)
```

### Import and view data
```{r message = FALSE}
df <- read_csv("cleaned_data.csv")
head(df)
```

#### questions to answer
1. What is his win percentage overall & grouped by color?
2. Which is his best opening overall, grouped by color?
3. Which opening does he play the most overall, grouped by color?
4. Does he lose more against higher rated opponents?
5. What is the average move count in his games?
6. Which year did he perform the best in?
7. Who does he play with most often?

### **1. What is His Win Percentage Overall?**
```{r echo=F, message = FALSE}
# count of win, draw, loss
overall_win <- df %>%
  group_by(Result) %>%
  summarise(Count = n())

# vars for inline code
ngame <- summarise(df, n()) %>% as.character()
wins <- overall_win[3, 2] %>% as.character()
loss <- overall_win[2, 2] %>% as.character()
draw <- overall_win[1, 2] %>% as.character()
wr <- round(as.numeric(wins) / as.numeric(ngame) * 100, 2)

# plot
overall_win %>%
  ggplot(aes(x = reorder(Result, -Count), y = Count)) +
  geom_bar(stat = "identity", width = 0.6) +
  labs(
    title = "Comparison of number of wins, losses, and draws",
    x = "Result"
  )
```
His win percentage is `r wr` %. Out of 
`r ngame` games, `r wins` are wins, `r loss` are losses, and `r draw`
are draws.  Most of his games ends in a win or a draw. 


### **2. What is His Win Percentage Grouped by Color?**
```{r echo = F, message = FALSE}
# ratio of win, draw, loss by color
winrate <- df %>%
  group_by(Color, Result) %>%
  summarise(count = n()) %>%
  mutate(Percentage = count / sum(count) * 100) %>%
  select(-count) 

# vars for inline code
w_wr <- round(winrate[6, 3], 2) %>% as.character()
b_wr <- round(winrate[3, 3], 2) %>% as.character()

# plot
winrate %>%
  ggplot(aes(x = Color, y = Percentage, fill = Result)) +
  geom_bar(stat = "identity", position = "fill", width = 0.6) +
  coord_flip() +
  labs(
    title = "Ratio of Wins, Losses & Draws Grouped by Color",
    y = "Win : Loss : Draw"
  )
```
His win-rate as white is `r w_wr`, which is higher than his win-rate as  
black `r b_wr`. Win to loss to draw ratio is roughly the same as white  
or black.


### **3. Which Opening Does He Play the Most Overall?**
```{r echo = FALSE, message = FALSE}
# openings and their game count
overall_op <- df %>%
  group_by(Opening) %>%
  summarise(N_games = n()) %>%
  arrange(desc(N_games))

# top 10 most played openings
head(overall_op, 10) %>%
  ggplot(aes(x = reorder(Opening, N_games), y = N_games)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(
    title = "Most Played Openings Overall",
    x = "Opening",
    y = "Number of Games"
  )
```

### **4. Which Opening Does He Play the Most Grouped by Color?**
```{r echo = FALSE, message = FALSE}
# top 10 most played openings grouped by color
top_by_color <- df %>%
  group_by(Color, Opening) %>%
  summarise(N_games = n()) %>%
  top_n(n = 10, wt = N_games)

# top 10 most played openings by white
white <- head(top_by_color, 10) %>%
  ggplot(aes(x = reorder(Opening, N_games), y = N_games)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(
    title = "Most Played Openings as White",
    x = "Openings",
    y = "Number of Games"
  )

# top 10 most played openings by black
black <- tail(top_by_color, 10) %>%
  ggplot(aes(x = reorder(Opening, N_games), y = N_games)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(
    title = "Most Played Openings as Black",
    x = "Openings",
    y = "Number of Games"
  )

grid.arrange(white, black)
```
It looks like the most played opening is the sicilian defense for both  
white and black. This might happen because there are many variations of  
the sicilian defense, but all of them are grouped together in the data.


### **4. Does He Lose More Against Higher Rated Opponents?**
```{r echo = FALSE, message = FALSE}
# results when playing against/not against higher rated opponents
vs_high <- df %>%
  mutate(Vs_higher = if_else(Opponent_rating > Rating, "yes","no")) %>%
  group_by(Vs_higher, Result) %>%
  summarise(count = n()) %>%
  mutate(Percentage = count / sum(count) * 100) %>%
  select(-count) %>%
  arrange(desc(Vs_higher)) %>%
  ggplot(aes(x = Vs_higher, y = Percentage, fill = Result)) +
  geom_bar(stat = "identity", width = 0.6) +
  coord_flip() +
  labs(
    title = "Ratio of Wins, Losses & Draws against higher/lower opponents",
    x = "VS higher-rated opponents?",
    y = "Win:Loss:Draw"
  )
```

### What is the average move count in his games & does move count affect the result of games?
```{r echo = FALSE, message = FALSE}
# move count distribution
df %>%
  ggplot(aes(x = Moves)) +
  geom_histogram(binwidth = 5) +
  labs(
    title = "distribution of move count of games",
    x = "move count of games"
  )

# avg moves for win/draw/loss
df %>%
  group_by(Result) %>%
  summarise(Mean_moves = mean(Moves)) %>%
  ggplot(aes(x = reorder(Result, Mean_moves), y = Mean_moves)) +
  geom_bar(stat = "identity", width = 0.6) +
  labs(
    title = "Average move counts of different game results",
    x = "Results",
    y = "Average move count"
  )
```

### Which year did he perform the best in?
ratings start from 2003, the year he became a gm. his highest rating was
in 2015.
```{r echo = FALSE, message = FALSE}
# highest rating of each year 2003-2020
df %>%
  group_by(Year) %>%
  filter(Year > 2002) %>%
  summarise(highest_rt = max(Rating, na.rm = TRUE)) %>%
  ggplot(aes(x = Year, y = highest_rt)) +
  geom_line() +
  scale_x_continuous(breaks = seq(2002, 2020, 2)) +
  labs(
    title = "Yearly highest rating",
    y = "Highest rating"
  )
```

### Who does he play with most often?
```{r echo = FALSE, message = FALSE}
# top 10 most played opponents
reg_opp <- df %>%
  group_by(Opponent) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) %>%
  head(10)

# top 10 barchart
reg_opp %>%
  ggplot(aes(x = reorder(Opponent, n), y = n)) +
  geom_bar(stat = "identity", width = 0.6) +
  coord_flip() +
  labs(
    title = "Top 10 players he plays with most often",
    x = "Opponent",
    y = "Number of games played"
  )

# w/d/l ratio against them
df %>%
  group_by(Opponent, Result) %>%
  filter(Opponent %in% reg_opp$Opponent) %>%
  summarise(n = n()) %>%
  ggplot(aes(x = Opponent, y = n, fill = Result)) +
  geom_bar(stat = "identity",position = "fill", width = 0.6) +
  coord_flip() +
  labs(
    title = "Results against the players he plays with most often",
    x = "Opponent",
    y = "Win:Loss:Draw"
  )
```

### which openings have higher winrates?


```{r}
# openings with game number > 20
freq_op <- df %>%
  group_by(Opening) %>%
  summarise(count = n()) %>%
  filter(count > 20)

# colors, openings, results 
op_res <- df %>%
  select(Color, Opening, Result) %>%
  filter(Opening %in% freq_op$Opening)

# cochran-mantel-haenszel tes on op_res
tb <- table(op_res$Color, op_res$Opening, op_res$Result)

# H0 = opening & color have no effect on result
# H1 = opening & color have an effect on result
mantelhaen.test(tb)
# reject null hypothesis 

# top 10 op overal
df %>%
  filter(Opening %in% op_res$Opening) %>%
  group_by(Opening, Result) %>%
  summarise(Count = n()) %>%
  mutate(Winrate = round(Count / sum(Count) * 100, 2)) %>%
  filter(Result == "Win") %>%
  select(-Count, -Result) %>%
  arrange(desc(Winrate)) %>%
  head(10) %>%
  ggplot(aes(x = reorder(Opening, Winrate), y = Winrate)) +
  geom_bar(stat = "Identity", width = 0.6) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    title = "Top 10 Win-rates of Openings played by Hikaru Nakamura",
    x = "Opening",
    y = "Win-rate in percentages(%)"
  )

# top 10 white op
df %>%
  filter(Opening %in% x$Opening) %>%
  group_by(Color, Opening, Result) %>%
  summarise(Count = n()) %>%
  mutate(Winrate = round(Count / sum(Count) * 100, 2)) %>%
  filter(Result == "Win" & Color == "White") %>%
  select(-Count, -Result) %>%
  arrange(desc(Winrate)) %>%
  head(10) %>%
  ggplot(aes(x = reorder(Opening, Winrate), y = Winrate)) +
  geom_bar(stat = "Identity", width = 0.6) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    title = "Top 10 Win-rates of Openings Played as White",
    x = "Opening",
    y = "Win-rate in percentages(%)"
  )

# top 10 black op
df %>%
  filter(Opening %in% x$Opening) %>%
  group_by(Color, Opening, Result) %>%
  summarise(Count = n()) %>%
  mutate(Winrate = round(Count / sum(Count) * 100, 2)) %>%
  filter(Result == "Win" & Color == "Black") %>%
  select(-Count, -Result) %>%
  arrange(desc(Winrate)) %>%
  head(10) %>%
  ggplot(aes(x = reorder(Opening, Winrate), y = Winrate)) +
  geom_bar(stat = "Identity", width = 0.6) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    title = "Top 10 Win-rates of Openings Played as Black",
    x = "Opening",
    y = "Win-rate in percentages(%)"
  )
```

